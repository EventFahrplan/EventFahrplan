import nerd.tuxmobil.fahrplan.congress.Android
import nerd.tuxmobil.fahrplan.congress.Libs
import org.gradle.api.tasks.testing.logging.TestExceptionFormat
import org.gradle.api.tasks.testing.logging.TestLogEvent

ext.set("APP_VERSION", "${gitSha()}")

apply plugin: "com.android.application"
apply plugin: "kotlin-android"
apply plugin: "de.mobilej.unmock"
apply plugin: "org.sonarqube"
apply from: "../sonarqube.gradle"

Properties props = new Properties()
File gradlePropertiesFile = file("gradle.properties")
if (!gradlePropertiesFile.exists()) {
    throw new IllegalStateException(
            "Please create the file 'gradle.properties' before " +
                    "importing the project. Do not forget to add custom values!"
    )
}
props.load(new FileInputStream(gradlePropertiesFile))

android {
    compileSdkVersion Android.compileSdkVersion
    buildToolsVersion Android.buildToolsVersion

    defaultConfig {
        versionCode 65
        versionName "1.41.3"
        minSdkVersion Android.minSdkVersion
        targetSdkVersion Android.targetSdkVersion
        archivesBaseName = "Fahrplan-$versionName"

        vectorDrawables.useSupportLibrary = true

        // Build information
        buildConfigField "String", "BUILD_TIME", "\"${buildTime()}\""
        buildConfigField "String", "GIT_SHA", "\"${gitSha()}\""
        buildConfigField "String", "C3NAV_URL", "\"https://36c3.c3nav.de/l/\""
        buildConfigField "boolean", "ENABLE_ENGELSYSTEM_SHIFTS", "false"
    }

    buildTypes {
        debug {
            versionNameSuffix "-DEBUG"
            applicationIdSuffix ".debug"
            zipAlignEnabled true
            debuggable true
        }
        release {
            zipAlignEnabled true
            minifyEnabled true
            proguardFiles getDefaultProguardFile('proguard-android.txt'),
                    'proguard-rules/proguard-project.txt',
                    'proguard-rules/okhttp3.pro',
                    'proguard-rules/okio.pro'
        }
    }

    signingConfigs {
        ccc35c3 {
            storeFile file(props['signing.ccc35c3-release.keystoreFilePath'])
            storePassword props['signing.ccc35c3-release.keystorePassword']
            keyAlias props['signing.ccc35c3-release.keyAlias']
            keyPassword props['signing.ccc35c3-release.keyPassword']
        }
        cccamp2019 {
            storeFile file(props['signing.cccamp2019-release.keystoreFilePath'])
            storePassword props['signing.cccamp2019-release.keystorePassword']
            keyAlias props['signing.cccamp2019-release.keyAlias']
            keyPassword props['signing.cccamp2019-release.keyPassword']
        }
        ccc36c3 {
            storeFile file(props['signing.ccc36c3-release.keystoreFilePath'])
            storePassword props['signing.ccc36c3-release.keystorePassword']
            keyAlias props['signing.ccc36c3-release.keyAlias']
            keyPassword props['signing.ccc36c3-release.keyPassword']
        }
    }

    def defaultDimension = "default"
    flavorDimensions defaultDimension

    productFlavors {
        ccc35c3 {
            dimension defaultDimension
            applicationId "info.metadude.android.congress.schedule"
            signingConfig signingConfigs.ccc35c3
            buildConfigField "String", "SCHEDULE_URL", '"https://raw.githubusercontent.com/voc/35C3_schedule/master/everything.schedule.xml"'
            buildConfigField "String", "EVENT_URL", '"https://events.ccc.de/congress/2018/Fahrplan/events/%1$s.html"'
            buildConfigField "String", "SERVER_BACKEND_TYPE", '"frab"'
            buildConfigField "int", "SCHEDULE_FIRST_DAY_START_YEAR", "2018"
            buildConfigField "int", "SCHEDULE_FIRST_DAY_START_MONTH", "12"
            buildConfigField "int", "SCHEDULE_FIRST_DAY_START_DAY", "27"
            buildConfigField "int", "SCHEDULE_LAST_DAY_END_YEAR", "2018"
            buildConfigField "int", "SCHEDULE_LAST_DAY_END_MONTH", "12"
            buildConfigField "int", "SCHEDULE_LAST_DAY_END_DAY", "31"
            buildConfigField "boolean", "SHOW_APP_DISCLAIMER", "false"
            buildConfigField "boolean", "ENGAGE_C3NAV_APP_INSTALLATION", "true"
            buildConfigField "boolean", "ENGAGE_GOOGLE_BETA_TESTING", "true"
            buildConfigField "boolean", "ENGAGE_GOOGLE_PLAY_RATING", "true"
            buildConfigField "String", "TRACE_DROID_EMAIL_ADDRESS", '"tobias.preuss+35c3@googlemail.com"'
            buildConfigField "String", "SCHEDULE_FEEDBACK_URL", '"https://frab.cccv.de/en/35C3/public/events/%s/feedback/new"'
        }
        cccamp2019 {
            dimension defaultDimension
            applicationId "info.metadude.android.cccamp.schedule"
            versionName "1.41.3-CCCamp-Edition"
            signingConfig signingConfigs.cccamp2019
            buildConfigField "String", "SCHEDULE_URL", '"https://data.c3voc.de/camp2019/everything.schedule.xml"'
            buildConfigField "String", "EVENT_URL", '"http://events.ccc.de/camp/2019/Fahrplan/events/%1$s.html"'
            buildConfigField "String", "SERVER_BACKEND_TYPE", '"frab"'
            buildConfigField "int", "SCHEDULE_FIRST_DAY_START_YEAR", "2019"
            buildConfigField "int", "SCHEDULE_FIRST_DAY_START_MONTH", "8"
            buildConfigField "int", "SCHEDULE_FIRST_DAY_START_DAY", "21"
            buildConfigField "int", "SCHEDULE_LAST_DAY_END_YEAR", "2019"
            buildConfigField "int", "SCHEDULE_LAST_DAY_END_MONTH", "8"
            buildConfigField "int", "SCHEDULE_LAST_DAY_END_DAY", "26"
            buildConfigField "boolean", "SHOW_APP_DISCLAIMER", "false"
            buildConfigField "boolean", "ENGAGE_C3NAV_APP_INSTALLATION", "false"
            buildConfigField "boolean", "ENGAGE_GOOGLE_BETA_TESTING", "true"
            buildConfigField "boolean", "ENGAGE_GOOGLE_PLAY_RATING", "true"
            buildConfigField "String", "TRACE_DROID_EMAIL_ADDRESS", '"tobias.preuss+camp2019@googlemail.com"'
            buildConfigField "String", "SCHEDULE_FEEDBACK_URL", '"https://frab.cccv.de/en/camp2019/public/events/%s/feedback/new"'
        }
        ccc36c3 {
            dimension defaultDimension
            applicationId "info.metadude.android.congress.schedule"
            signingConfig signingConfigs.ccc36c3
            buildConfigField "String", "SCHEDULE_URL", '"https://raw.githubusercontent.com/voc/36C3_schedule/master/everything.schedule.xml"'
            buildConfigField "String", "EVENT_URL", '"https://events.ccc.de/congress/2019/Fahrplan/events/%1$s.html"'
            buildConfigField "String", "SERVER_BACKEND_TYPE", '"frab"'
            buildConfigField "int", "SCHEDULE_FIRST_DAY_START_YEAR", "2019"
            buildConfigField "int", "SCHEDULE_FIRST_DAY_START_MONTH", "12"
            buildConfigField "int", "SCHEDULE_FIRST_DAY_START_DAY", "27"
            buildConfigField "int", "SCHEDULE_LAST_DAY_END_YEAR", "2019"
            buildConfigField "int", "SCHEDULE_LAST_DAY_END_MONTH", "12"
            buildConfigField "int", "SCHEDULE_LAST_DAY_END_DAY", "31"
            buildConfigField "boolean", "SHOW_APP_DISCLAIMER", "false"
            buildConfigField "boolean", "ENGAGE_C3NAV_APP_INSTALLATION", "true"
            buildConfigField "boolean", "ENGAGE_GOOGLE_BETA_TESTING", "true"
            buildConfigField "boolean", "ENGAGE_GOOGLE_PLAY_RATING", "true"
            buildConfigField "boolean", "ENABLE_ENGELSYSTEM_SHIFTS", "true"
            buildConfigField "String", "TRACE_DROID_EMAIL_ADDRESS", '"tobias.preuss+36c3@googlemail.com"'
            buildConfigField "String", "SCHEDULE_FEEDBACK_URL", '"https://frab.cccv.de/en/36C3/public/events/%s/feedback/new"'
        }
    }

    lintOptions {
        // for okio - https://github.com/square/okio/issues/58
        warning "InvalidPackage"
        warning "MissingDefaultResource"
    }

    compileOptions {
        targetCompatibility JavaVersion.VERSION_1_8
        sourceCompatibility JavaVersion.VERSION_1_8
    }
}

unMock {
    keepStartingWith "libcore."
    keep "android.net.Uri"
    keep "android.util.Patterns"
    keepAndRename "java.nio.charset.Charsets" to "xjava.nio.charset.Charsets"
}

tasks.withType(Test) {
    testLogging {
        events TestLogEvent.FAILED,
                TestLogEvent.PASSED,
                TestLogEvent.SKIPPED,
                TestLogEvent.STANDARD_ERROR,
                TestLogEvent.STANDARD_OUT
        exceptionFormat TestExceptionFormat.FULL
        showCauses true
        showExceptions true
        showStackTraces true
    }
}

dependencies {
    implementation project(":database")
    implementation project(":network")
    implementation project(":engelsystem")

    implementation Libs.kotlinCoroutinesAndroid
    implementation Libs.kotlinCoroutinesCore
    implementation Libs.kotlinStdlib
    implementation Libs.supportLibraryAppcompatV7
    implementation Libs.supportLibraryConstraintLayout
    implementation Libs.supportLibraryDesign
    implementation Libs.okhttp
    implementation Libs.okhttpLoggingInterceptor
    implementation Libs.snackengagePlayrate
    implementation Libs.emailIntentBuilder
    implementation Libs.tracedroid

    testImplementation Libs.junit
    testImplementation Libs.assertjAndroid
    testImplementation Libs.supportLibraryAnnotations
    testImplementation Libs.mockitoCore
    testImplementation Libs.mockitoKotlin
    testImplementation Libs.threeTenBp

    unmock Libs.robolectric
}

def gitSha() {
    def res = 'git rev-parse --short HEAD'.execute([], project.rootDir).text.trim()
    def diff = 'git diff'.execute([], project.rootDir).text.trim()
    if (diff != null && diff.length() > 0) {
        res += "-dirty"
    }
    return res
}

def buildTime() {
    return new Date().format("yyyy-MM-dd'T'HH:mm'Z'", TimeZone.getTimeZone("UTC"))
}
